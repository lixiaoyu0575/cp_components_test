<!DOCTYPE html>
<meta charset="utf-8">
<title>SANKEY Experiment</title>
<style>

    rect {
        /*cursor: move;*/
        fill-opacity: .6;
        /*shape-rendering: crispEdges;*/
        stroke-width: .5;
        stroke: black;
    }

    .node text {
        pointer-events: none;
        text-shadow: 0 1px 0 #fff;
    }

    .link {
        fill: none;
        stroke: #000;
        stroke-opacity: .2;
    }

    .link:hover {
        stroke-opacity: .5;
    }

</style>
<body>
<a href="/">back</a>

<p id="chart">

    <script src="./libs/d3.v3.min.js"></script>
    <script>

        var units = "Widgets";

        var margin = {top: 10, right: 10, bottom: 10, left: 10},
            width = 1500 - margin.left - margin.right,
            height = 3000 - margin.top - margin.bottom;

        var formatNumber = d3.format(",.0f"),    // zero decimal places
            format = function(d) { return formatNumber(d) + " " + units; },
            color = d3.scale.category20();

        // append the svg canvas to the page
        var svg = d3.select("#chart").append("svg");
            svg.attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");
        var nodesName = ["消化系统药物", "循环系统药物", "内分泌系统药物", "眼科用药", "水、电解质及酸碱平衡用药", "测血压", "血细胞分析+五分类", "糖化血红蛋白测定", "血清肌钙蛋白Ⅰ测定", "血同型半胱氨酸测定", "B型前脑尿钠肽检测（Pro-BNP）", "电脑血糖监测", "心电监护", "尿常规(分析+尿沉渣定量)[复]", "粪常规[复]", "心肌酶谱(五项)[复]", "输血四项[复]", "心脏三位[复]", "甲功七项（放免）[复]", "心动超声[复]", "凝血六项[复]", "肾功五项[复]", "血脂八项[复]", "电解质六项[复]", "肝功十三项[复]", "双侧腹股沟备皮", "双上肢备皮", "术前4-6小时禁饮食", "拟手术", "葡萄糖耐量试验", "同步胰岛素释放试验（四次）[复]", "CAG+PCI", "血液系统药物", "皮肤科用药", "抗生素", "肌肉注射", "静脉输液", "使用一次性精密过滤器输液加收", "院内会诊(主治医师）", "今日出院", "呼吸系统药物", "血清肌钙蛋白T测定", "输血四项(急诊)[复]", "双侧腹股沟区及上肢备皮", "术前禁食4-6小时", "中抢救", "血气分析3[复]", "经皮冠状动脉内支架置入术(STENT)", "其他用药", "床旁拍片[复]", "一般细菌涂片检查", "一般细菌培养及鉴定", "肝功五项[复]", "转出CCU", "转入心内科4病区", "持续吸氧", "留陪人", "肺通气功能检查", "肺弥散功能检查", "64排CT平扫（每部位）[复]", "支气管舒张试验", "静脉采血", "颈部血管彩色多普勒超声", "双肾及肾血管彩色多普勒超声", "肾功六项[复]", "超敏C反应蛋白测定", "多层CT平扫（每部位）[复]", "吸氧", "冠状动脉造影术", "双侧腹股沟区备皮", "正位片[复]", "小换药", "病危", "记24小时出入量", "血气分析", "经皮冠状动脉腔内成形术(PTCA)", "转重6床", "中换药", "报院内感染", "泌尿系统药物", "静脉注射", "肿瘤标志物乳腺癌检测[复]", "肿瘤标志物卵巢癌检测[复]", "低流量吸氧", "书面病危", "记出入量", "双下肢静脉彩超检查[复]", "彩色多普勒超声常规检查", "风湿三项[复]", "肺癌三项[复]", "结缔组织全套[复]", "请肾内科会诊", "请消化内科会诊", "64层及以上螺旋CT冠脉成像（单源）", "CTA刻盘[复]", "局麻下下肢静脉造影+下腔静脉+肺动脉造影备滤器植入术", "参麦", "请呼吸科会诊", "万他维", "右心导管检查术", "经皮静脉内溶栓术", "经皮静脉内滤网置入术", "神经系统药物", "甲功八项(放免)[复]", "转重五床", "抗变态反应药物", "取消昨日手术", "取消今日手术", "心肌灌注显像[复]", "动脉采血", "生脉", "血浆D-二聚体定量检测", "乙肝五项[复]", "院内会诊（副主任医师以上）", "血气分析1[复]", "抗病毒颗粒", "取消2012-10-15手术", "皮试", "延长管", "微量泵或输液泵静脉输液", "抗肿瘤药物", "消化科会诊", "血液科会诊", "网织红细胞计数(Ret)", "贫血因子三项[复]", "搬38床", "乙型肝炎DNA定量测定", "乙肝六项[复]", "右前臂+双腹股沟备皮", "诺和针", "尿红细胞位相", "瑞舒伐他汀(可定)", "重症监护", "必要时吸氧", "卡式交叉配血", "血型鉴定", "红细胞1u", "上消化道造影[复]", "红细胞沉降率测定(血沉)(ESR)", "C—反应蛋白测定(CRP)", "经皮选择性静脉置管术", "患肢抬高30°", "书面病重", "凝血酶时间测定", "血浆纤维蛋白原测定", "搬6床", "磁共振平扫(1T以上不含1T)", "普食", "正、侧位[复]", "术区备皮", "经皮穿刺球囊扩张腰2椎体后凸成形术", "C型臂术中透视", "结核菌涂片检查", "注射用水(玻)", "面罩吸氧", "告病危", "指脉氧监测", "鼻导管吸氧 3L/min", "心肌损伤检测", "坦索罗辛（哈乐）", "经食管心脏调搏术", "转1床", "双侧颈胸部备皮", "腔内电生理+射频消融术", "谷胱甘肽还原性(绿汀诺)", "钾测定", "丙型肝炎RNA定量测定", "甲胎蛋白测定(AFP)", "肿瘤标志物十项(男)[复]", "尿蛋白定量", "停昨日术前液体医嘱", "清热解毒", "头孢地嗪（康丽能）", "转39床", "转重4床", "转36床", "三九感冒灵冲", "取消今日CAG+PCI术", "正电子发射计算机断层-X线计算机体层部位显像（PET/CT）", "正电子发射计算机断层-X线计算机体层全身显像（PET/CT）", "取消昨日CAG+PCI术", "微量泵或输液泵连续输液", "小儿微量泵或输液泵静脉输液", "四肢血管彩色多普勒超声", "肌电图(四肢)(门诊)[复]", "永久起搏器更换术", "双侧颈胸部备皮+双侧腹股沟备皮", "转21床", "取消明日CAG+PCI术", "肺灌注显像[复]", "小抢救", "B型尿钠钛检测(BNP)", "灌肠", "倒31床", "依折麦布(益适纯)", "转12床", "自动出院", "搬入5床", "转至重5床", "血尿β2-MG[复]", "输红细胞悬液1u", "腹部彩色多普勒超声造影", "颈椎六位[复]", "请内分泌科会诊", "卧床休息", "肝门部胆管病变切除术", "明日在局麻下行下肢动脉造影备动脉成形术", "单上肢动脉彩超检查[复]", "经皮动脉支架置入术", "双下肢动脉彩超检查[复]", "转周围血管科28病区7床", "肌电图(双肢)(住院)[复]", "电子生物反馈疗法", "请康复科会诊", "百令胶囊", "经皮超选择性动脉造影术", "经皮动脉内球囊扩张术", "请骨科会诊", "磁共振水成象(MRCP,MRM,MRU,FLAIR)", "癌胚抗原测定(CEA)", "糖类抗原测定CA-125", "糖类抗原测定CA19-9", "低脂半流食", "术前清洁灌肠", "术前12小时禁食6小时禁饮", "术前下胃管", "备红细胞4u，血浆400ml", "左外叶切除+胆道探查+T管引流术", "静脉高营养治疗", "备红细胞2u，血浆400ml", "输红细胞2u，血浆400ml", "静脉输血", "痰热清", "按胆囊切除+肝左外叶切除+胆道镜探查+T管引流术", "留置肝断面引流管记量", "留置T管记量", "胃肠减压", "留置导尿", "血氧饱和度监测", "引流管引流", "留置网膜孔引流管记量", "特大换药", "留置贴膜(美敷)", "测血糖3次/日", "流食", "B超常规检查", "床旁B超检查", "抗返流引流袋", "多层CT灌注成像[复]", "记２４小时出入量", "尿蛋白二项[复]", "颅内多普勒血流图(TCD)", "金水宝胶囊", "维生素类药物", "院内会诊", "测血压bid", "双侧腹股沟上胸前臂备皮", "14×17吋感绿片", "绝对卧床休息", "冠状动脉+左心室造影术", "口头告病重", "左甲状腺素（优甲乐）", "彩色胶片照相", "心梗三项[复]", "严格卧床休息", "间断低流量吸氧", "经皮氧饱和度监测", "术前双侧腹股沟区+右前臂备皮", "定于今日急诊局麻下行CAG，备PCI术", "搬51床", "定于今日局麻下行二次PCI术", "报疫卡", "报疫卡(乙肝)", "多层CT增强扫描[复]", "转26床", "止咳桃花散", "定于明日局麻下行CAG，备PCI术", "肝炎系列(甲乙丙戊)[复]", "取消手术安排", "持续低流量吸氧", "测血糖 1次每小时", "诺和笔", "搬31床", "转至9床", "经直肠B超检查", "静脉肾盂造影(CR)[复]", "肾动态显像+GFR[复]", "测血压 2次/日", "测血糖 7次/日", "脱落细胞学检查与诊断", "诺和锐8u三餐前 ih", "诺和锐特充14u   10pm  ih", "头孢地嗪（康丽能）［—］", "混合糖电解质(新海能)", "降钙素原检测", "诺和平特充14u  10pm  ih", "术前备皮", "术前晚通便灌肠", "左侧输尿管口肿瘤电切术（备膀胱部分切)", "会阴擦洗", "测血糖３次／日", "持续膀胱冲洗", "测血糖7次/日", "诺和平特充16u  10pm  ih", "经皮主动脉气囊反搏动术(IABP)", "床旁超声心动图", "抗血小板药物抵抗基因测定", "调节可达龙25ml/h", "拔除IABP", "血培养及鉴定", "厌氧菌培养及鉴定", "转心内科1区", "总前列腺特异性抗原测定(TPSA)", "游离前列腺特异性抗原测定(FPSA)", "腹股沟+右前臂备皮", "替比夫定(素比伏)", "心脏电复律术", "使用一次性导尿包导尿", "钠测定", "转至5床", "报疫卡(乙型肝炎)", "低脂流食", "测清晨空腹、三餐前及餐后两小时、晚十点血糖、", "参芪扶正", "请心血管内科医师会诊", "多酶", "电子胃十二指肠镜检查", "术中约冰冻", "红细胞2u", "血浆200ml", "胰十二指肠切除术（Whipple手术）", "记尿量", "留置文氏孔引流管记量", "淀粉酶测定", "经皮冠状动脉内溶栓术", "继续今日手术", "CAG备PCI", "冠心病", "动态血压监测", "颅内段血管彩色多普勒超声", "骨密度测定", "转40床", "测血糖4次/日", "测血压2次/日", "停今日手术", "停明日手术", "双侧腹股沟部备皮", "腹腔镜胆囊切除术", "留置腹腔引流管计量", "腹腔镜胆囊切除术后", "(留置贴膜)美敷", "8IU入乳酸钠葡萄糖组", "麻醉药及其辅助药物", "请神经内科会诊", "双侧腹股沟区+右前臂备皮", "绝对卧床", "术前禁食４－６小时", "CAG+备PCI", "大换药", "转入19床", "妇产科用药", "术前禁食", "备皮（右前臂+会阴部+右侧腹股沟）", "定于明晨行CAG+PCI", "定于下周一行CAG+PCI", "低分子肝素术前临时停用", "氧气吸入", "双侧腹股沟及颈胸部备皮", "术前禁食4～6小时", "转37床", "永久起搏器安置术", "拔除尿管", "取消明日手术", "定于明日行CAG+PCI", "右腕双侧腹股沟备皮", "病重", "物理降温", "枕冰帽", "搬33床", "右前臂+双腹股沟区备皮", "血栓弹力图试验（TEG）", "今日行PTCA术", "明日出院", "四联活菌（思连康）", "起搏器功能分析和随访", "术前备皮（会阴部+腹股沟+右上胸部）", "定于下周一下午行起搏器更换术", "内毒素+D葡聚糖测定[复]", "曲霉菌血清学试验", "肿瘤标志物九项(女)[复]", "测体温", "上中（全）消化道造影[复]", "结核杆菌抗体测定IgG", "结核杆菌定量(TB-DNA)", "血清蛋白电泳", "抗中性粒细胞胞浆抗体测定（ANCA）", "抗环瓜氨酸肽抗体（抗CCP抗体）检测", "巨细胞病毒PP65抗原测定", "肺炎支原体血清学试验（IgM）", "免疫八项[复]", "TORCH( 五项)[复]", "EB病毒定量(EB-DNA)", "肺炎支原体定量(MP-DNA)", "羚羊感冒口服液", "转33床", "甲功五项(放免)[复]", "IABP应用", "无创呼吸机应用", "CYP2C19基因检测[复]", "取消BNP、心肌损伤检测", "黄龙止咳颗粒", "复方红衣补血口服液", "贝伐珠单抗(安维汀)", "普通透视", "彩色打印照片", "普通视力检查", "眼压检查", "裂隙灯检查", "眼底检查", "光学相干断层成相(OCT)", "备眼", "泪道冲洗", "冲洗结膜囊", "玻璃体穿刺抽液术", "玻璃体切除术", "激光治疗眼前节病", "暂停手术，恢复医嘱", "请心内科急会诊", "胰岛素注射", "极化液每分钟30滴", "请呼吸内科会诊", "取消手术", "取消B型脑钠肽检测", "转至3床", "双侧腹股沟上胸上臂备皮", "取消CT安排", "葡萄糖测定", "术前4-6小时禁食", "取消今日于局麻下行CAG+PCI术", "双侧颈胸部及双侧腹股沟区备皮", "取消消化道造影", "明日行CAG+PCI术", "甲状旁腺激素测定", "术前通便灌肠", "术前禁食水", "左侧PCNL", "尿结石成份分析", "留置肾造瘘管接袋计量", "留置导尿计量", "腹部平片（单一立位或卧位）[复]", " 术前禁食4-6小时", "CAG+PCI`", "转至重1床", "转至10床", "转7床", "请肝胆外科急会诊", "请消化科急会诊", "谷胱甘肽还原性(阿拓莫兰)", "转5床", "报院感", "CAG+左室造影备PCI", "盐酸贝那普利 10mg 1次/日", "苯磺酸氨氯地平片 5mg  1次/日", "今日急诊在局麻下行CAG+PCI术", "转18床", "肺灌注显象", "转32床", "床旁彩色多普勒超声检查加收", "开塞露", "间断吸氧", "请泌尿外科会诊", "双侧腹股沟区+右前臂区备皮", "搬10床", "测清晨空腹、三餐前及餐后两小时、晚十时血糖", "测血压4次/日", "院内眼科会诊", "手术取消", "院内心内科会诊", "LC", " 院内呼吸内科会诊", "转至37床", "射频消融术", "已报院内感染", "记24小时尿量", "四肢血管彩色多普勒超声每增加一根加收", "无机磷测定", "乙肝、丙肝[复]", "(尿本-周氏蛋白)免疫固定电泳", "肢体静脉动脉化", "吻合器组件", "一般物理降温", "请眼科急会诊", "请肾内科急会诊", "床旁血滤2012年12月27日、29日各一次", "床旁血滤2013年1月1、4、6日各一次", "重组人促红素(济脉欣)", "床旁血滤一次", "暂停今日手术", "吸氧，必要时", "双侧腕部备皮", "明日在局麻下行CAG备PCI术", "取消今日出院", "磁共振平扫（3T及以上）", "术前手术区备皮", "术前12小时禁食、4小时禁饮", "定于周五在全麻下行胆囊切除备肝转移癌射频消融术", "术前替他欣皮试（）", "术前配血", "术前留置胃肠减压", "术前留置导尿", "胆囊切除备肝转移癌射频消融术", "肥皂水800ml通便灌肠", "特殊物理降温", "卒中教育", "预防肢体瘫痪", "全血CRP/超敏CRP联合测定[复]", "请术区备皮", "定于明日８时在局麻下行全脑血管造影术", "经股动脉插管全脑动脉造影术", "观察足背动脉搏动情况", "穿刺部位加压包扎6小时", "穿刺肢体制动24小时", "血管紧张素+醛固酮系统(立位)(放免)[复]", "血管紧张素+醛固酮系统(卧位)(放免)[复]", "右腕及双侧腹股沟区备皮", "双侧腹股沟区+手腕部备皮"];
        // Set the sankey diagram properties
//        var sankey = d3.sankey()
//            .nodeWidth(4)
//            .nodePadding(2)
//            .size([width, height]);
//
//        var path = sankey.link();

        // load the data
        //        d3.json("./data/sankey-formatted2.json", function(error, graph) {
        d3.json("./data/output2front_sequences.json", function(error, graph) {
            console.log(graph);
            var rectsData = [],
                maxLength = 11,
                padding = 1,
                sequenceNum = graph.length;
            for (var i = 0;i < sequenceNum;i++) {
                for(var j = 0;j < graph[i][0].length;j++) {
                    if (graph[i][0].length > maxLength) {
                        maxLength = graph[i][0].length;
                    }
                    var temp = graph[i][0][j].split(",");
                    var index2 = temp[temp.length - 1] -1;
                    var rect = {
                        "index1": i,
                        "index2": index2,
                        "name": graph[i][0][j],
                        "value": graph[i][1]
                    };
                    rect.isComposite = graph[i][0][j].split(",").length > 2 ? 1 : 0;
                    rectsData.push(rect);
                }
            }
            console.log(maxLength);
            svg.append("g").selectAll(".node")
                .data(rectsData)
                .enter()
                .append("rect")
                .attr("x", function (d) {
//                    console.log(d);
                    return width / maxLength * d.index2;
                })
                .attr("y", function (d) {
                    return height / sequenceNum * d.index1;
                })
                .attr("width", function (d) {
                    return width / maxLength - padding;
                })
                .attr("height", function (d) {
                    return height / sequenceNum - padding;
                })
                .attr("fill", function (d) {
                    if (d.isComposite === 0) {
                        console.log(d.name.split(",")[0]);
                        console.log(nodesName.indexOf(d.name.split(",")[0]));
                        return color(nodesName.indexOf(d.name.split(",")[0]) % 20)
                    }else {
                        return "#fff";
                    }
                });
            svg.append("g").selectAll(".node")
                .data(rectsData)
                .enter()
                .append("text")
                .attr("x", function (d) {
                    console.log(d);
                    return width / maxLength * d.index2 - (width / maxLength - padding);
                })
                .attr("y", function (d) {
                    return height / sequenceNum * d.index1;
                })
                .attr("dx", function (d) {
                    return width / maxLength - padding;
                })
                .attr("dy", function (d) {
                    return height / sequenceNum - padding;
                })
                .text(function (d) {
                    return d.name
                })
                .style("font-size", 10);
//            svg.data(graph)
//                .selectAll("g")
//                .enter()
//                .append("rect")
//                .attr("x", function (d) {
//                    console.log(d);
//                })
        });

    </script>

</body>
</html>